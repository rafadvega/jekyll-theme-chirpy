<!DOCTYPE html><html lang="es" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Creando un laboratorio para threat hunting VI. Desplegando Splunk" /><meta name="author" content="Rafa de Vega" /><meta property="og:locale" content="es" /><meta name="description" content="Desplegando Splunk" /><meta property="og:description" content="Desplegando Splunk" /><link rel="canonical" href="https://rafadvega.github.io/posts/Creando-un-laboratorio-para-threat-hunting-vi/" /><meta property="og:url" content="https://rafadvega.github.io/posts/Creando-un-laboratorio-para-threat-hunting-vi/" /><meta property="og:site_name" content="rdevega" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-05T05:33:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Creando un laboratorio para threat hunting VI. Desplegando Splunk" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Rafa de Vega"},"dateModified":"2023-05-20T22:58:59+02:00","datePublished":"2021-08-05T05:33:00+02:00","description":"Desplegando Splunk","headline":"Creando un laboratorio para threat hunting VI. Desplegando Splunk","mainEntityOfPage":{"@type":"WebPage","@id":"https://rafadvega.github.io/posts/Creando-un-laboratorio-para-threat-hunting-vi/"},"url":"https://rafadvega.github.io/posts/Creando-un-laboratorio-para-threat-hunting-vi/"}</script><title>Creando un laboratorio para threat hunting VI. Desplegando Splunk | rdevega</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="rdevega"><meta name="application-name" content="rdevega"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="es"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/images/logo.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">rdevega</a></div><div class="site-subtitle font-italic">Blog sobre ciberseguridad centrado en Threat Hunting e IR</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>INICIO</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVOS</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ACERCA DE</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/rafadvega" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://www.linkedin.com/in/rdevega" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['rafadevega','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Inicio </a> </span> <span>Creando un laboratorio para threat hunting VI. Desplegando Splunk</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancelar</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Creando un laboratorio para threat hunting VI. Desplegando Splunk</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Rafa de Vega </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 5, 2021, 5:33 AM +0200" >Aug 5, 2021<i class="unloaded">2021-08-05T05:33:00+02:00</i> </span></div><div> <span> Actualizado <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, May 20, 2023, 9:58 PM +0100" >May 20<i class="unloaded">2023-05-20T22:58:59+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1115 words">6 min leer</span></div></div><div class="post-content"><h1 id="desplegando-splunk">Desplegando Splunk</h1><h2 id="instalación-del-servidor">Instalación del servidor</h2><p>Comenzaremos creando la máquina virtual, en este caso usaremos una Debian 11, pero como podemos ver en la documentación, las opciones son múltiples:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img1.bmp" alt="img" width="1086" height="542" /></p><p>Como podemos ver, incluimos dos interfaces de red, una conectada a la subred de nuestro laboratorio, y otra en modo bridge. Esta segunda, es para hacer un poco de trampa, y poder conectar a nuestro splunk directamente desde nuestro equipo. Otra opción sería exponer el servicio a través del nuestro pfSense, o conectarnos desde una máquina dentro del dominio.</p><p>Una vez instalado el sistema operativo, deberemos configurar una ip estática dentro de la subred del laboratorio, y de paso también lo podemos hacer con la interfaz que conecta con nuestra red local para saber siempre donde estará disponible Splunk. Para ello editaremos el fichero “/etc/network/interfaces” con el siguiente contenido (ojo con los nombres de la insterfaces de red, que puede variar, para verlos podemos ejecutar un “ip addr”):</p><div lang="yaml" class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="s">auto &lt;nombreInterfaz1&gt;</span>
<span class="s">iface &lt;nombreInterfaz1&gt; inet static</span>
<span class="err">	</span><span class="s">addresss &lt;ip rango laboratorio&gt;</span>
<span class="err">	</span><span class="s">netmask &lt;máscara de nuestro rango&gt;</span>
<span class="err">	</span><span class="s">gateway &lt;ip del pfsense&gt;</span>

<span class="s">auto &lt;nombreInterfaz2&gt;</span>
<span class="s">iface &lt;nombreInterfaz2&gt; inet static</span>
<span class="err">	</span><span class="s">addresss &lt;ip rango local&gt;</span>
<span class="err">	</span><span class="s">netmask &lt;máscara de nuestro rango local&gt;</span>
<span class="err">	</span><span class="s">gateway &lt;ip del gateway de nuestra red local&gt;</span>
</pre></table></code></div></div><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img2.bmp" alt="img" width="1086" height="542" /></p><p>El siguiente paso es descargar el binario de splunk desde su web (será necesario registrarse):</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img3.bmp" alt="img" width="1086" height="542" /></p><p>En nuestro caso elegiremos el .deb, pero elegiremos el correspondiente de nuestro SO.</p><p>Para descargarlo directamente en nuestra máquina, podemos usar el comando wget que nos facilita splunk:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img4.bmp" alt="img" width="1086" height="542" /></p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img5.bmp" alt="img" width="1086" height="542" /></p><p>Ejecutaremos el siguiente comando para instalarlo:</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>dpkg <span class="nt">-i</span> nombre_del_paquete_de_splunk.deb
</pre></table></code></div></div><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img6.bmp" alt="img" width="1086" height="542" /></p><p>A continuación lo arrancaremos con el comando:</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>splunk start <span class="nt">--accept-license</span> <span class="nt">--answer-yes</span>
</pre></table></code></div></div><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img7.bmp" alt="img" width="1086" height="542" /></p><p>Y ya tendremos el servicio de splunk listo en el puerto 8000:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img8.bmp" alt="img" width="1086" height="542" /></p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img9.bmp" alt="img" width="1086" height="542" /></p><p>Nos logeamos con la contraseña anteriormente introducida, y lo primero que haremos será configurar la licencia. La licencia de prueba solamente durará 30 días, pero la licencia gratuita es indefinida. Careceremos de configuración de alertas, autenticación, etc, y limitado a una ingesta de 500MB al día de logs. Todo esto es más que suficiente para nuestro laboratorio. Así pues, iremos a Settings-&gt;licensing. Aquí pulsaremos “Add license” y seleccionaremos “Free”:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img10.bmp" alt="img" width="1086" height="542" /></p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img11.bmp" alt="img" width="1086" height="542" /></p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img12.bmp" alt="img" width="1086" height="542" /></p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img13.bmp" alt="img" width="1086" height="542" /></p><p>Por último, con el siguiente comando, habilitaremos la ejecución automática de splunk cada vez que se inicie la máquina:</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>splunk <span class="nb">enable </span>boot-start
</pre></table></code></div></div><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img14.bmp" alt="img" width="1086" height="542" /></p><p>El siguiente paso será instalar en splunk los “Add-on” que nos parsearan nuestros eventos para una búsqeuda y visualización más sencilla. Seleccionaremos “Manage APPs” y buscaremos “Windows”. La primera que aparece es la que instalaremos:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img15.bmp" alt="img" width="1086" height="542" /></p><p>Continuaremos con la de sysmon y auditd:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img16.bmp" alt="img" width="1086" height="542" /></p><p>A continuación debemos crear el “listener” que escuchará para recibir los eventos de los agentes. Para esto desplegaremos los setttings, y pincharemos en “Forwarding and receiving”:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img22.bmp" alt="img" width="1086" height="542" /></p><p>Ĺuego “Configure receiving”, y elegiremos un puerto:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img23.bmp" alt="img" width="1086" height="542" /></p><p>Y por último, debemos crear los index dónde guardaremos nuestros logs. Crearemos dos:</p><ul><li>wineventlog: para los eventos de windows<li>os: para los de linux</ul><p>Para crearlos, iremos a Settings-&gt;Indexes-&gt;New Index:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img25.bmp" alt="img" width="1086" height="542" /></p><p>Repetimos lo mismo para el index os ya tenemos listo nuestro servidor con Splunk, pasemos a nuestro DC para instalar el agente.</p><h2 id="instalación-agente-windows">Instalación agente Windows</h2><p>Volveremos a la web de splunk para descargarnos el “Splunk Universal Forwarder” para la correspondiente plataforma:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img17.bmp" alt="img" width="1086" height="542" /></p><p>Seguimos las instrucciones para la instalación, seleccionando el puerto antes configurado (para el deployment server es indiferente, ya que no lo usaremos):</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img18.bmp" alt="img" width="1086" height="542" /></p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img19.bmp" alt="img" width="1086" height="542" /></p><p>A continuación deberemos definir en el equipo el fichero outputs.conf(configuración de a dónde envía los eventos) e inputs.conf (configuración de qué eventos se lleva el agente de la máquina). Ambos se encuentran en el directorio “C:\Program Files\SplunkUniversalForwarder\etc\system\local" Tras la instalación indicada, el outputs debería haberse generado automáticamente con algo como lo que sigue:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img20.bmp" alt="img" width="1086" height="542" /></p><p>En cuanto al inputs.conf, lo crearemos en el mismo directorio, con el siguiente contenido:</p><div lang="yaml" class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
</pre><td class="rouge-code"><pre><span class="pi">[</span><span class="nv">default</span><span class="pi">]</span>
<span class="s">host=$decideOnStartup</span>

<span class="pi">[</span><span class="nv">WinEventLog</span><span class="pi">:</span><span class="nv">//Security</span><span class="pi">]</span>
<span class="s">disabled=0</span>
<span class="s">index = wineventlog</span>
<span class="s">source = XmlWinEventLog:Security</span>
<span class="s">sourcetype = XmlWinEventLog</span>
<span class="s">evt_resolve_ad_obj=1</span>
<span class="s">renderXml = </span><span class="kc">true</span>
<span class="s">suppress_text = </span><span class="kc">true</span>
<span class="s">suppress_sourcename = </span><span class="kc">true</span>
<span class="s">suppress_keywords = </span><span class="kc">true</span>
<span class="s">suppress_task = </span><span class="kc">true</span>
<span class="s">suppress_opcode = </span><span class="kc">true</span>
<span class="s">blacklist = </span><span class="m">4703</span>
<span class="s">blacklist1 = EventCode="4688" $XmlRegex="(&lt;Data Name='NewProcessName'&gt;(C:\\Program Files\\SplunkUniversalForwarder\\bin\\*)&lt;\/Data&gt;)"</span>

<span class="pi">[</span><span class="nv">WinEventLog</span><span class="pi">:</span><span class="nv">//Microsoft-Windows-WinRM/Operational</span><span class="pi">]</span>
<span class="s">renderXml = </span><span class="kc">true</span>
<span class="s">suppress_text = </span><span class="kc">true</span>
<span class="s">suppress_sourcename = </span><span class="kc">true</span>
<span class="s">suppress_keywords = </span><span class="kc">true</span>
<span class="s">suppress_task = </span><span class="kc">true</span>
<span class="s">suppress_opcode = </span><span class="kc">true</span>
<span class="s">disabled = </span><span class="m">0</span>
<span class="s">index = wineventlog</span>
<span class="s">sourcetype = XmlWinEventLog</span>
<span class="s">source = XmlWinEventLog:WinRM</span>
<span class="s">evt_resolve_ad_obj=1</span>

<span class="pi">[</span><span class="nv">WinEventLog</span><span class="pi">:</span><span class="nv">//Microsoft-Windows-PowerShell/Operational</span><span class="pi">]</span>
<span class="s">disabled = </span><span class="m">0</span>
<span class="s">renderXml = </span><span class="kc">true</span>
<span class="s">suppress_text = </span><span class="kc">true</span>
<span class="s">suppress_sourcename = </span><span class="kc">true</span>
<span class="s">suppress_keywords = </span><span class="kc">true</span>
<span class="s">suppress_task = </span><span class="kc">true</span>
<span class="s">suppress_opcode = </span><span class="kc">true</span>
<span class="s">index = wineventlog</span>
<span class="s">sourcetype = XmlWinEventLog</span>
<span class="s">source = XmlWinEventLog:Powershell</span>
<span class="s">evt_resolve_ad_obj=1</span>


<span class="pi">[</span><span class="nv">WinEventLog</span><span class="pi">:</span><span class="nv">//Windows PowerShell</span><span class="pi">]</span>
<span class="s">disabled = </span><span class="m">0</span>
<span class="s">renderXml = </span><span class="kc">true</span>
<span class="s">suppress_text = </span><span class="kc">true</span>
<span class="s">suppress_sourcename = </span><span class="kc">true</span>
<span class="s">suppress_keywords = </span><span class="kc">true</span>
<span class="s">suppress_task = </span><span class="kc">true</span>
<span class="s">suppress_opcode = </span><span class="kc">true</span>
<span class="s">index = wineventlog</span>
<span class="s">sourcetype = XmlWinEventLog</span>
<span class="s">source = XmlWinEventLog:Powershell</span>
<span class="s">evt_resolve_ad_obj=1</span>

<span class="pi">[</span><span class="nv">WinEventLog</span><span class="pi">:</span><span class="nv">//Microsoft-Windows-TaskScheduler/Operational</span><span class="pi">]</span>
<span class="s">disabled = </span><span class="m">0</span>
<span class="s">renderXml = </span><span class="kc">true</span>
<span class="s">suppress_text = </span><span class="kc">true</span>
<span class="s">suppress_sourcename = </span><span class="kc">true</span>
<span class="s">suppress_keywords = </span><span class="kc">true</span>
<span class="s">suppress_task = </span><span class="kc">true</span>
<span class="s">suppress_opcode = </span><span class="kc">true</span>
<span class="s">index = wineventlog</span>
<span class="s">sourcetype = XmlWinEventLog</span>
<span class="s">source = XmlWinEventLog:TaskScheduler</span>
<span class="s">evt_resolve_ad_obj=1</span>

<span class="pi">[</span><span class="nv">WinEventLog</span><span class="pi">:</span><span class="nv">//Microsoft-Windows-TerminalServices-LocalSessionManager/Operational</span><span class="pi">]</span>
<span class="s">disabled = </span><span class="m">0</span>
<span class="s">renderXml = </span><span class="kc">true</span>
<span class="s">suppress_text = </span><span class="kc">true</span>
<span class="s">suppress_sourcename = </span><span class="kc">true</span>
<span class="s">suppress_keywords = </span><span class="kc">true</span>
<span class="s">suppress_task = </span><span class="kc">true</span>
<span class="s">suppress_opcode = </span><span class="kc">true</span>
<span class="s">index = wineventlog</span>
<span class="s">sourcetype = XmlWinEventLog</span>
<span class="s">source = XmlWinEventLog:TerminalServices</span>
<span class="s">evt_resolve_ad_obj=1</span>

<span class="pi">[</span><span class="nv">WinEventLog</span><span class="pi">:</span><span class="nv">//Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational</span><span class="pi">]</span>
<span class="s">disabled = </span><span class="m">0</span>
<span class="s">index = wineventlog</span>
<span class="s">renderXml = </span><span class="kc">true</span>
<span class="s">suppress_text = </span><span class="kc">true</span>
<span class="s">suppress_sourcename = </span><span class="kc">true</span>
<span class="s">suppress_keywords = </span><span class="kc">true</span>
<span class="s">suppress_task = </span><span class="kc">true</span>
<span class="s">suppress_opcode = </span><span class="kc">true</span>
<span class="s">sourcetype = XmlWinEventLog</span>
<span class="s">source = XmlWinEventLog:TerminalServices</span>
<span class="s">evt_resolve_ad_obj=1</span>

<span class="pi">[</span><span class="nv">WinEventLog</span><span class="pi">:</span><span class="nv">//Microsoft-Windows-Sysmon/Operational</span><span class="pi">]</span>
<span class="s">disabled = </span><span class="kc">false</span>
<span class="s">renderXml = </span><span class="kc">true</span>
<span class="s">index = wineventlog</span>
<span class="s">source = XmlWinEventLog:Microsoft-Windows-Sysmon/Operational</span>
</pre></table></code></div></div><p>Una vez guardado, reiniciamos el splunk forwarder, por ejemplo desde powershell:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img21.bmp" alt="img" width="1086" height="542" /></p><p>Y si comprobamos nuestro Splunk, ya deberíamos tener eventos:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img24.bmp" alt="img" width="1086" height="542" /></p><p>Repetiremos estos pasos para todas las máquinas windows que hayamos desplegado.</p><h2 id="instalación-agente-linux">Instalación agente Linux</h2><p>Para nuestra máquina RedHat, los pasos son muy parecidos. Descargamos el agente:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img26.bmp" alt="img" width="1086" height="542" /></p><p>Instalamos el agente:</p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img27.bmp" alt="img" width="1086" height="542" /></p><p>Lo iniciamos con el comando:</p><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./splunk start <span class="nt">--accept-license</span>
</pre></table></code></div></div><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img28.bmp" alt="img" width="1086" height="542" /></p><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1086 542'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/splunk/img19.bmp" alt="img" width="1086" height="542" /></p><p>En este caso, el outputs.conf será idéntico al de windows, pero lo deberemos configurar a mano:</p><div lang="yaml" class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="pi">[</span><span class="nv">tcpout</span><span class="pi">]</span>
<span class="s">defaultGroup = default-autolb-group</span>

<span class="pi">[</span><span class="nv">tcpout</span><span class="pi">:</span><span class="nv">default-autolb-group</span><span class="pi">]</span>
<span class="s">server = 10.0.89.9:9997</span>

<span class="pi">[</span><span class="nv">tcpout-server</span><span class="pi">:</span><span class="nv">//10.0.89.9</span><span class="pi">:</span><span class="nv">9997</span><span class="pi">]</span>
</pre></table></code></div></div><p>Y en el inputs.conf usaremos la siguiente configuración:</p><div lang="yaml" class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="pi">[</span><span class="nv">default</span><span class="pi">]</span>
<span class="s">host = LINUXSERVER1</span>

<span class="pi">[</span><span class="nv">monitor</span><span class="pi">:</span><span class="nv">///var/log/audit/*</span><span class="pi">]</span>
<span class="s">disabled = </span><span class="m">0</span>
<span class="s">sourcetype = linux:audit</span>
<span class="s">index = os</span>

<span class="pi">[</span><span class="nv">monitor</span><span class="pi">:</span><span class="nv">///var/log/secure</span><span class="pi">]</span>
<span class="s">disabled = </span><span class="m">0</span>
<span class="s">sourcetype = linux:auth</span>
<span class="s">index = os</span>
</pre></table></code></div></div><p>Por último comprobamos que los logs están llegando a Splunk y…</p><p>NUESTRO LABORATORIO ESTÁ LISTO PARA SU USO!!!!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/threat-hunting/'>Threat Hunting</a>, <a href='/categories/laboratorio/'>Laboratorio</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/threat-hunting/" class="post-tag no-text-decoration" >threat hunting</a> <a href="/tags/hunting/" class="post-tag no-text-decoration" >hunting</a> <a href="/tags/laboratorio/" class="post-tag no-text-decoration" >laboratorio</a> <a href="/tags/splunk/" class="post-tag no-text-decoration" >splunk</a> <a href="/tags/siem/" class="post-tag no-text-decoration" >SIEM</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> Esto es un post bajo licencia <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> .</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartir</span> <span class="share-icons"> <a href="https://es.linkedin.com/in/rdevega" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Creando un laboratorio para threat hunting VI. Desplegando Splunk - rdevega&u=https://rafadvega.github.io/posts/Creando-un-laboratorio-para-threat-hunting-vi/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Creando un laboratorio para threat hunting VI. Desplegando Splunk - rdevega&url=https://rafadvega.github.io/posts/Creando-un-laboratorio-para-threat-hunting-vi/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copiado!')" data-toggle="tooltip" data-placement="top" title="Copiar Link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Última actualización</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Creando-un-laboratorio-para-threat-hunting-v/">Creando un laboratorio para threat hunting V. Configurando la auditoría de los sistemas operativos</a><li><a href="/posts/Creando-un-laboratorio-para-threat-hunting-vi/">Creando un laboratorio para threat hunting VI. Desplegando Splunk</a><li><a href="/posts/Creando-un-laboratorio-para-threat-hunting-i/">Creando un laboratorio para threat hunting I. Introducción</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hunting/">hunting</a> <a class="post-tag" href="/tags/laboratorio/">laboratorio</a> <a class="post-tag" href="/tags/threat-hunting/">threat hunting</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/redhat/">redhat</a> <a class="post-tag" href="/tags/auditor%C3%ADa/">auditoría</a> <a class="post-tag" href="/tags/dc/">dc</a> <a class="post-tag" href="/tags/domain-controller/">domain controller</a> <a class="post-tag" href="/tags/firewall/">firewall</a> <a class="post-tag" href="/tags/pfsense/">pfsense</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contenidos</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Creando-un-laboratorio-para-threat-hunting-i/"><div class="card-body"> <span class="timeago small" >Jul 1, 2021<i class="unloaded">2021-07-01T05:33:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Creando un laboratorio para threat hunting I. Introducción</h3><div class="text-muted small"><p> En esta serie de posts, nos centraremos en crear un pequeño laboratorio para nuestros ejercicios de threat hunting, existen varias soluciones ya automatizadas. como pueden ser DetectionLab o adaz,...</p></div></div></a></div><div class="card"> <a href="/posts/Creando-un-laboratorio-para-threat-hunting-ii/"><div class="card-body"> <span class="timeago small" >Jul 8, 2021<i class="unloaded">2021-07-08T05:33:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Creando un laboratorio para threat hunting II. Desplegando pfSense</h3><div class="text-muted small"><p> Desplegando pfSense. El primer paso en la preparación de nuestro laboratorio será desplegar nuestro firewall. La máquina virtual de pfsense, deberá tener dos interfaces de red, una para la LAN, que...</p></div></div></a></div><div class="card"> <a href="/posts/Creando-un-laboratorio-para-threat-hunting-iii/"><div class="card-body"> <span class="timeago small" >Jul 15, 2021<i class="unloaded">2021-07-15T05:33:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Creando un laboratorio para threat hunting III. Desplegando Controlador de dominio</h3><div class="text-muted small"><p> Desplegando el Controlador de Dominio. Instalación del servidor El siguiente paso en nuestro despliegue, será desplegar el controlador de dominio. Para ello, emplearemos una versión de evaluación ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Creando-un-laboratorio-para-threat-hunting-v/" class="btn btn-outline-primary" prompt="Older"><p>Creando un laboratorio para threat hunting V. Configurando la auditoría de los sistemas operativos</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//rafadvega.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Creando un laboratorio para threat hunting VI. Desplegando Splunk'; this.page.url = 'https://rafadvega.github.io/posts/Creando-un-laboratorio-para-threat-hunting-vi/'; this.page.identifier = '/posts/Creando-un-laboratorio-para-threat-hunting-vi/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://www.linkedin.com/in/rdevega">Rafa de Vega</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/hunting/">hunting</a> <a class="post-tag" href="/tags/laboratorio/">laboratorio</a> <a class="post-tag" href="/tags/threat-hunting/">threat hunting</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/redhat/">redhat</a> <a class="post-tag" href="/tags/auditor%C3%ADa/">auditoría</a> <a class="post-tag" href="/tags/dc/">dc</a> <a class="post-tag" href="/tags/domain-controller/">domain controller</a> <a class="post-tag" href="/tags/firewall/">firewall</a> <a class="post-tag" href="/tags/pfsense/">pfsense</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://rafadvega.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No se han encontrado resultados.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-MWKT6JFF0L"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-MWKT6JFF0L'); }); </script>
